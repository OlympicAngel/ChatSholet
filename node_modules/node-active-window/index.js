/**
 * NOT ORIGIANL FILE!
 * Edited slightly so this could properly run as compiled exe;
 * It had problems on allowing reading "detection scripts" (tested on windows) as powershell
 * didnt managed to read the script from "snapshot" folder.
 * fixed using copying script to local foler, executing it and deleting it afterwards.
 * +edit in the main function to wait for copy to end.
 */

const fs = require('fs');
const configs = require('./configs.json');
const path = require('path');
var config = undefined; //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ modified

exports.getActiveWindow = function (callback, repeats = 1, interval = 0) {
    if (!config || !config.ok) {
        if (!config || !config.loading) {
            config = {};
            config.loading = true;
            config = getConfig();
        }
        setTimeout(() => {
            exports.getActiveWindow(callback, repeats, interval);
        }, 200);
        return;
    }

    const spawn = require('child_process').spawn;

    //Scape negative number of repeats on Windows OS
    if (process.platform == 'win32' && repeats < 0) {
        repeats = '\\-1';
    }

    let parameters = Object.assign([], config.parameters);
    parameters.push(repeats);
    parameters.push(process.platform == 'win32' ? (interval * 1000 | 0) : interval);
    const ls = spawn(config.bin, parameters);
    ls.stdout.setEncoding('utf8');

    ls.stdout.on('data', function (stdout) {
        //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ modified
        if (config.ok || config.loading) {
            config.ok = false;
            config.loading = false;
            fs.unlinkSync(config.path);
            console.log(config.path);
        }
        //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ modified
        callback(null, reponseTreatment(stdout.toString()));
    });

    //Obtain error response from script
    ls.stderr.on("data", function (stderr) {
        callback(stderr.toString(), null);
    });

    ls.stdin.end();
}

/**
 * Treat and format the response string and put it into a object
 * @function reponseTreatment
 * @param {string} String received from script
 */
function reponseTreatment(response) {
    window = {};
    if (process.platform == 'linux') {
        response = response.replace(/(WM_CLASS|WM_NAME)(\(\w+\)\s=\s)/g, '').split("\n", 2);
        window.app = response[0];
        window.title = response[1];
    } else if (process.platform == 'win32') {
        response = response.replace(/(@{ProcessName=| AppTitle=)/g, '').slice(0, -1).split(';', 2);
        window.app = response[0];
        window.title = response[1];
    } else if (process.platform == 'darwin') {
        response = response.split(",");
        window.app = response[0];
        window.title = response[1].replace(/\n$/, "").replace(/^\s/, "");
    }
    return window;
}

function getConfig() {
    let config;

    switch (process.platform) {
        case 'linux':
        case 'linux2':
            config = configs.linux
            break;
        case 'win32':
            config = configs.win32
            break;
        case 'darwin':
            config = configs.mac;
            break;
        default:
            throw "Operating System not supported yet. " + process.platform;
    }

    //Append directory to script url
    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ modified
    script_url = path.join(__dirname, config.script_url);
    var name;
    if (fs.existsSync(script_url)) {
        name = script_url.split("\\");
        name = name[name.length - 1];

        fs.readFile(script_url, 'utf8', function (err, data) {
            if (err) {
                return console.log(err);
            }
            script_url = process.cwd() + "/" + name;

            fs.writeFile(script_url, data, function (err) {
                if (err) {
                    return console.log(err);
                }
                config.path = script_url;
                config.parameters.push(script_url);
                config.ok = true;
            });
        });
    }
    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ modified

    //Append directory to subscript url on OSX
    if (process.platform == 'darwin') {
        config.parameters.push(path.join(__dirname, config.subscript_url));
    }

    return config;
}